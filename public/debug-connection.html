<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç½‘ç»œè¿æ¥è°ƒè¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .warning { background-color: #fff3cd; color: #856404; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .disabled {
            background-color: #6c757d !important;
            cursor: not-allowed !important;
        }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ” Web3 ç½‘ç»œè¿æ¥è°ƒè¯•å·¥å…·</h1>
    
    <div id="status"></div>
    
    <h2>æµ‹è¯•æ­¥éª¤</h2>
    <button onclick="testWalletConnection()">1. æµ‹è¯•é’±åŒ…è¿æ¥</button>
    <button onclick="testNetworkConnection()">2. æµ‹è¯•ç½‘ç»œè¿æ¥</button>
    <button onclick="testContractConnection()">3. æµ‹è¯•åˆçº¦è¿æ¥</button>
    <button onclick="testSimpleTransaction()">4. æµ‹è¯•ç®€å•äº¤æ˜“</button>
    
    <div id="results"></div>

    <script>
        let web3;
        let accounts = [];
        let chainId;
        
        const contractAddresses = {
            "1337": {
                "SimpleBank": "0xf3dcB0d7497694405D433de5F46C6e77A8Fc467E",
                "VotingCore": "0x0ea3dd08Fe63166DdEeFf22745CB774CfAD03337"
            }
        };
        
        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = message;
            results.appendChild(div);
            console.log(message);
        }
        
        async function testWalletConnection() {
            log('ğŸ”„ æµ‹è¯•é’±åŒ…è¿æ¥...', 'info');
            
            if (typeof window.ethereum === 'undefined') {
                log('âŒ æœªæ£€æµ‹åˆ° MetaMask æˆ–å…¶ä»– Web3 é’±åŒ…', 'error');
                return false;
            }
            
            try {
                // è¯·æ±‚è¿æ¥é’±åŒ…
                accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });
                
                if (accounts.length === 0) {
                    log('âŒ æ²¡æœ‰å¯ç”¨çš„è´¦æˆ·', 'error');
                    return false;
                }
                
                log(`âœ… é’±åŒ…è¿æ¥æˆåŠŸï¼Œè´¦æˆ·: ${accounts[0]}`, 'success');
                
                // è·å–å½“å‰ç½‘ç»œ
                chainId = await window.ethereum.request({
                    method: 'eth_chainId'
                });
                
                const chainIdDecimal = parseInt(chainId, 16);
                log(`âœ… å½“å‰ç½‘ç»œ Chain ID: ${chainIdDecimal} (0x${chainIdDecimal.toString(16)})`, 'success');
                
                if (chainIdDecimal !== 1337) {
                    log(`âš ï¸ å½“å‰ä¸åœ¨ Ganache ç½‘ç»œ (Chain ID: 1337)`, 'warning');
                    log('è¯·åœ¨ MetaMask ä¸­åˆ‡æ¢åˆ° Ganache ç½‘ç»œ', 'warning');
                }
                
                return true;
            } catch (error) {
                log(`âŒ é’±åŒ…è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                return false;
            }
        }
        
        async function testNetworkConnection() {
            log('ğŸ”„ æµ‹è¯•ç½‘ç»œè¿æ¥...', 'info');
            
            if (!accounts.length) {
                log('âŒ è¯·å…ˆè¿æ¥é’±åŒ…', 'error');
                return false;
            }
            
            try {
                // è·å–è´¦æˆ·ä½™é¢
                const balance = await window.ethereum.request({
                    method: 'eth_getBalance',
                    params: [accounts[0], 'latest']
                });
                
                const balanceInEth = parseInt(balance, 16) / Math.pow(10, 18);
                log(`âœ… è´¦æˆ·ä½™é¢: ${balanceInEth.toFixed(4)} ETH`, 'success');
                
                if (balanceInEth < 0.01) {
                    log('âš ï¸ è´¦æˆ·ä½™é¢è¾ƒä½ï¼Œå¯èƒ½å½±å“äº¤æ˜“', 'warning');
                }
                
                // è·å–æœ€æ–°åŒºå—å·
                const blockNumber = await window.ethereum.request({
                    method: 'eth_blockNumber'
                });
                
                log(`âœ… æœ€æ–°åŒºå—: ${parseInt(blockNumber, 16)}`, 'success');
                
                // æµ‹è¯•Gasä»·æ ¼
                const gasPrice = await window.ethereum.request({
                    method: 'eth_gasPrice'
                });
                
                const gasPriceInGwei = parseInt(gasPrice, 16) / Math.pow(10, 9);
                log(`âœ… Gas ä»·æ ¼: ${gasPriceInGwei} Gwei`, 'success');
                
                return true;
            } catch (error) {
                log(`âŒ ç½‘ç»œè¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                return false;
            }
        }
        
        async function testContractConnection() {
            log('ğŸ”„ æµ‹è¯•åˆçº¦è¿æ¥...', 'info');
            
            const currentChainId = parseInt(chainId, 16);
            const addresses = contractAddresses[currentChainId.toString()];
            
            if (!addresses) {
                log(`âŒ æ²¡æœ‰æ‰¾åˆ° Chain ID ${currentChainId} çš„åˆçº¦åœ°å€`, 'error');
                return false;
            }
            
            try {
                // æµ‹è¯• SimpleBank åˆçº¦
                const bankAddress = addresses.SimpleBank;
                log(`ğŸ”„ æµ‹è¯• SimpleBank åˆçº¦: ${bankAddress}`, 'info');
                
                // æ£€æŸ¥åˆçº¦ä»£ç 
                const code = await window.ethereum.request({
                    method: 'eth_getCode',
                    params: [bankAddress, 'latest']
                });
                
                if (code === '0x') {
                    log(`âŒ SimpleBank åˆçº¦åœ¨åœ°å€ ${bankAddress} æ²¡æœ‰æ‰¾åˆ°ä»£ç `, 'error');
                    return false;
                }
                
                log(`âœ… SimpleBank åˆçº¦ä»£ç å­˜åœ¨ (${code.length} å­—ç¬¦)`, 'success');
                
                // æµ‹è¯• VotingCore åˆçº¦
                const votingAddress = addresses.VotingCore;
                log(`ğŸ”„ æµ‹è¯• VotingCore åˆçº¦: ${votingAddress}`, 'info');
                
                const votingCode = await window.ethereum.request({
                    method: 'eth_getCode',
                    params: [votingAddress, 'latest']
                });
                
                if (votingCode === '0x') {
                    log(`âŒ VotingCore åˆçº¦åœ¨åœ°å€ ${votingAddress} æ²¡æœ‰æ‰¾åˆ°ä»£ç `, 'error');
                    return false;
                }
                
                log(`âœ… VotingCore åˆçº¦ä»£ç å­˜åœ¨ (${votingCode.length} å­—ç¬¦)`, 'success');
                
                return true;
            } catch (error) {
                log(`âŒ åˆçº¦è¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                return false;
            }
        }
        
        async function testSimpleTransaction() {
            log('ğŸ”„ æµ‹è¯•ç®€å•äº¤æ˜“...', 'info');
            
            const currentChainId = parseInt(chainId, 16);
            if (currentChainId !== 1337) {
                log('âŒ è¯·åˆ‡æ¢åˆ° Ganache ç½‘ç»œ (Chain ID: 1337)', 'error');
                return false;
            }
            
            try {
                // æ„é€ ä¸€ä¸ªç®€å•çš„è½¬è´¦äº¤æ˜“ï¼ˆè½¬ç»™è‡ªå·±ï¼‰
                const txParams = {
                    from: accounts[0],
                    to: accounts[0],
                    value: '0x0', // 0 ETH
                    gas: '0x5208', // 21000 gas
                    gasPrice: '0x3B9ACA00' // 1 Gwei
                };
                
                log('ğŸ”„ å‘é€æµ‹è¯•äº¤æ˜“...', 'info');
                
                const txHash = await window.ethereum.request({
                    method: 'eth_sendTransaction',
                    params: [txParams]
                });
                
                log(`âœ… äº¤æ˜“å‘é€æˆåŠŸ! Hash: ${txHash}`, 'success');
                
                // ç­‰å¾…äº¤æ˜“ç¡®è®¤
                log('ğŸ”„ ç­‰å¾…äº¤æ˜“ç¡®è®¤...', 'info');
                
                let receipt = null;
                let attempts = 0;
                
                while (!receipt && attempts < 30) {
                    try {
                        receipt = await window.ethereum.request({
                            method: 'eth_getTransactionReceipt',
                            params: [txHash]
                        });
                        
                        if (!receipt) {
                            await new Promise(resolve => setTimeout(resolve, 1000));
                            attempts++;
                        }
                    } catch (error) {
                        log(`âš ï¸ è·å–äº¤æ˜“æ”¶æ®å¤±è´¥ (å°è¯• ${attempts + 1}): ${error.message}`, 'warning');
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        attempts++;
                    }
                }
                
                if (receipt) {
                    log(`âœ… äº¤æ˜“ç¡®è®¤æˆåŠŸ! åŒºå—: ${parseInt(receipt.blockNumber, 16)}`, 'success');
                    log('ğŸ‰ ç½‘ç»œè¿æ¥å®Œå…¨æ­£å¸¸ï¼Œå¯ä»¥æ­£å¸¸å‘é€äº¤æ˜“', 'success');
                    return true;
                } else {
                    log('âš ï¸ äº¤æ˜“å‘é€æˆåŠŸä½†æœªèƒ½è·å–ç¡®è®¤', 'warning');
                    return true;
                }
                
            } catch (error) {
                log(`âŒ ç®€å•äº¤æ˜“æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                
                if (error.message.includes('User denied')) {
                    log('â„¹ï¸ ç”¨æˆ·å–æ¶ˆäº†äº¤æ˜“', 'info');
                } else if (error.message.includes('insufficient funds')) {
                    log('â„¹ï¸ è´¦æˆ·ä½™é¢ä¸è¶³', 'warning');
                } else {
                    log('ğŸ”§ å¯èƒ½çš„è§£å†³æ–¹æ¡ˆ:', 'info');
                    log('1. ç¡®ä¿ Ganache æ­£åœ¨è¿è¡Œ', 'info');
                    log('2. æ£€æŸ¥ MetaMask ç½‘ç»œè®¾ç½®', 'info');
                    log('3. é‡å¯ Ganache å’Œ MetaMask', 'info');
                }
                
                return false;
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºåˆå§‹çŠ¶æ€
        window.addEventListener('load', function() {
            log('ğŸš€ ç½‘ç»œè¿æ¥è°ƒè¯•å·¥å…·å·²åŠ è½½', 'info');
            log('è¯·æŒ‰é¡ºåºç‚¹å‡»æµ‹è¯•æŒ‰é’®è¿›è¡Œè¯Šæ–­', 'info');
        });
    </script>
</body>
</html> 