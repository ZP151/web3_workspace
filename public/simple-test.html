<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®€å•å·¥å‚æµ‹è¯•</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 600px; margin: 0 auto; }
        button { padding: 10px 20px; margin: 10px; background: #007cba; color: white; border: none; border-radius: 3px; cursor: pointer; }
        .result { margin: 10px 0; padding: 10px; background: #f0f0f0; border-radius: 3px; white-space: pre-wrap; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª ç®€å•å·¥å‚æµ‹è¯•</h1>
        
        <button onclick="connectAndTest()">è¿æ¥å¹¶æµ‹è¯•æŠ•ç¥¨å·¥å‚</button>
        <button onclick="testBankFactory()">æµ‹è¯•é“¶è¡Œå·¥å‚</button>
        
        <div id="result" class="result">ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•...</div>
    </div>

    <script>
        let web3;
        let currentAccount;
        
        async function connectAndTest() {
            const resultDiv = document.getElementById('result');
            try {
                resultDiv.textContent = 'æ­£åœ¨è¿æ¥Web3...';
                
                web3 = new Web3('http://127.0.0.1:7545');
                const accounts = await web3.eth.getAccounts();
                currentAccount = accounts[0];
                
                resultDiv.textContent += `\nå·²è¿æ¥: ${currentAccount}`;
                
                // ä½¿ç”¨æœ€æ–°çš„æŠ•ç¥¨å·¥å‚åœ°å€
                const factoryAddress = '0x5B84Ae8D44d6331843c17898F9EC204593429eC7';
                resultDiv.textContent += `\nä½¿ç”¨æŠ•ç¥¨å·¥å‚: ${factoryAddress}`;
                
                const factoryABI = [
                    {
                        "inputs": [{"internalType": "uint256", "name": "_duration", "type": "uint256"}],
                        "name": "createVoting",
                        "outputs": [{"internalType": "address", "name": "", "type": "address"}],
                        "stateMutability": "nonpayable",
                        "type": "function"
                    },
                    {
                        "inputs": [],
                        "name": "votingCount",
                        "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                        "stateMutability": "view",
                        "type": "function"
                    }
                ];
                
                const factory = new web3.eth.Contract(factoryABI, factoryAddress);
                
                // è·å–å½“å‰æŠ•ç¥¨æ•°é‡
                const count = await factory.methods.votingCount().call();
                resultDiv.textContent += `\nå½“å‰æŠ•ç¥¨åˆçº¦æ•°é‡: ${count}`;
                
                // åˆ›å»ºæ–°çš„æŠ•ç¥¨åˆçº¦
                resultDiv.textContent += `\næ­£åœ¨åˆ›å»ºæ–°çš„æŠ•ç¥¨åˆçº¦...`;
                const result = await factory.methods.createVoting(24 * 3600).send({
                    from: currentAccount,
                    gas: 3000000
                });
                
                resultDiv.textContent += `\näº¤æ˜“å“ˆå¸Œ: ${result.transactionHash}`;
                
                // è·å–æ–°çš„æŠ•ç¥¨æ•°é‡
                const newCount = await factory.methods.votingCount().call();
                resultDiv.textContent += `\næ–°çš„æŠ•ç¥¨åˆçº¦æ•°é‡: ${newCount}`;
                
                // è·å–æ–°åˆ›å»ºçš„åˆçº¦åœ°å€
                const newVotingAddress = await factory.methods.getVotingContract(newCount - 1).call();
                resultDiv.textContent += `\næ–°åˆ›å»ºçš„æŠ•ç¥¨åˆçº¦åœ°å€: ${newVotingAddress}`;
                
                // æµ‹è¯•æ–°åˆ›å»ºçš„æŠ•ç¥¨åˆçº¦
                const votingABI = [
                    {
                        "inputs": [],
                        "name": "candidatesCount",
                        "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                        "stateMutability": "view",
                        "type": "function"
                    },
                    {
                        "inputs": [{"internalType": "uint256", "name": "_candidateId", "type": "uint256"}],
                        "name": "getCandidate",
                        "outputs": [{"internalType": "string", "name": "", "type": "string"}, {"internalType": "uint256", "name": "", "type": "uint256"}, {"internalType": "bool", "name": "", "type": "bool"}],
                        "stateMutability": "view",
                        "type": "function"
                    }
                ];
                
                const voting = new web3.eth.Contract(votingABI, newVotingAddress);
                const candidatesCount = await voting.methods.candidatesCount().call();
                resultDiv.textContent += `\nå€™é€‰äººæ•°é‡: ${candidatesCount}`;
                
                if (candidatesCount > 0) {
                    const candidate = await voting.methods.getCandidate(0).call();
                    resultDiv.textContent += `\nç¬¬ä¸€ä¸ªå€™é€‰äºº: ${candidate[0]} (ç¥¨æ•°: ${candidate[1]})`;
                }
                
                resultDiv.textContent += `\nâœ… æŠ•ç¥¨å·¥å‚æµ‹è¯•æˆåŠŸï¼`;
                
            } catch (error) {
                resultDiv.textContent += `\nâŒ é”™è¯¯: ${error.message}`;
                console.error('æµ‹è¯•å¤±è´¥:', error);
            }
        }
        
        async function testBankFactory() {
            const resultDiv = document.getElementById('result');
            try {
                if (!web3) {
                    web3 = new Web3('http://127.0.0.1:7545');
                    const accounts = await web3.eth.getAccounts();
                    currentAccount = accounts[0];
                }
                
                resultDiv.textContent = 'æ­£åœ¨æµ‹è¯•é“¶è¡Œå·¥å‚...';
                
                // ä½¿ç”¨æœ€æ–°çš„é“¶è¡Œå·¥å‚åœ°å€
                const factoryAddress = '0x4e46D0a1c1a0A24a8e5506A58C474b82EAd0dFd2';
                resultDiv.textContent += `\nä½¿ç”¨é“¶è¡Œå·¥å‚: ${factoryAddress}`;
                
                const factoryABI = [
                    {
                        "inputs": [{"internalType": "bool", "name": "_withExtensions", "type": "bool"}],
                        "name": "createBank",
                        "outputs": [{"internalType": "address", "name": "", "type": "address"}, {"internalType": "address", "name": "", "type": "address"}],
                        "stateMutability": "nonpayable",
                        "type": "function"
                    },
                    {
                        "inputs": [],
                        "name": "bankCount",
                        "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                        "stateMutability": "view",
                        "type": "function"
                    },
                    {
                        "inputs": [{"internalType": "uint256", "name": "_bankId", "type": "uint256"}],
                        "name": "getBankContract",
                        "outputs": [{"internalType": "address", "name": "", "type": "address"}],
                        "stateMutability": "view",
                        "type": "function"
                    }
                ];
                
                const factory = new web3.eth.Contract(factoryABI, factoryAddress);
                
                // è·å–å½“å‰é“¶è¡Œæ•°é‡
                const count = await factory.methods.bankCount().call();
                resultDiv.textContent += `\nå½“å‰é“¶è¡Œåˆçº¦æ•°é‡: ${count}`;
                
                // åˆ›å»ºæ–°çš„é“¶è¡Œåˆçº¦
                resultDiv.textContent += `\næ­£åœ¨åˆ›å»ºæ–°çš„é“¶è¡Œåˆçº¦...`;
                const result = await factory.methods.createBank(true).send({
                    from: currentAccount,
                    gas: 3000000
                });
                
                resultDiv.textContent += `\näº¤æ˜“å“ˆå¸Œ: ${result.transactionHash}`;
                
                // è·å–æ–°çš„é“¶è¡Œæ•°é‡
                const newCount = await factory.methods.bankCount().call();
                resultDiv.textContent += `\næ–°çš„é“¶è¡Œåˆçº¦æ•°é‡: ${newCount}`;
                
                // è·å–æ–°åˆ›å»ºçš„åˆçº¦åœ°å€
                const newBankAddress = await factory.methods.getBankContract(newCount - 1).call();
                resultDiv.textContent += `\næ–°åˆ›å»ºçš„é“¶è¡Œåˆçº¦åœ°å€: ${newBankAddress}`;
                
                // æµ‹è¯•æ–°åˆ›å»ºçš„é“¶è¡Œåˆçº¦
                const bankABI = [
                    {
                        "inputs": [],
                        "name": "getBalance",
                        "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                        "stateMutability": "view",
                        "type": "function"
                    },
                    {
                        "inputs": [],
                        "name": "getBankBalance",
                        "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                        "stateMutability": "view",
                        "type": "function"
                    },
                    {
                        "inputs": [],
                        "name": "deposit",
                        "outputs": [],
                        "stateMutability": "payable",
                        "type": "function"
                    }
                ];
                
                const bank = new web3.eth.Contract(bankABI, newBankAddress);
                const bankBalance = await bank.methods.getBankBalance().call();
                resultDiv.textContent += `\né“¶è¡Œæ€»ä½™é¢: ${web3.utils.fromWei(bankBalance, 'ether')} ETH`;
                
                // æµ‹è¯•å­˜æ¬¾
                resultDiv.textContent += `\næ­£åœ¨å­˜å…¥0.1 ETH...`;
                await bank.methods.deposit().send({
                    from: currentAccount,
                    value: web3.utils.toWei('0.1', 'ether'),
                    gas: 200000
                });
                
                const userBalance = await bank.methods.getBalance().call({ from: currentAccount });
                resultDiv.textContent += `\nå­˜æ¬¾æˆåŠŸï¼æˆ‘çš„ä½™é¢: ${web3.utils.fromWei(userBalance, 'ether')} ETH`;
                
                resultDiv.textContent += `\nâœ… é“¶è¡Œå·¥å‚æµ‹è¯•æˆåŠŸï¼`;
                
            } catch (error) {
                resultDiv.textContent += `\nâŒ é”™è¯¯: ${error.message}`;
                console.error('æµ‹è¯•å¤±è´¥:', error);
            }
        }
    </script>
</body>
</html> 