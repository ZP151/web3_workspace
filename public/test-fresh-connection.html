<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨æ–°MetaMaskè¿æ¥æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        .button {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            margin: 10px;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: transform 0.2s;
        }
        .button:hover {
            transform: translateY(-2px);
        }
        .step {
            background: rgba(255, 255, 255, 0.2);
            padding: 20px;
            margin: 15px 0;
            border-radius: 10px;
            border-left: 4px solid #00d2d3;
        }
        .success {
            border-left-color: #00b894;
        }
        .warning {
            border-left-color: #fdcb6e;
        }
        .error {
            border-left-color: #e17055;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”„ å…¨æ–°MetaMaskè¿æ¥æµ‹è¯•</h1>
        
        <div class="step warning">
            <h3>âš ï¸ é‡è¦æç¤º</h3>
            <p>åœ¨å¼€å§‹ä¹‹å‰ï¼Œè¯·ç¡®ä¿ï¼š</p>
            <ul>
                <li>å·²ä»MetaMaskæ–­å¼€æ‰€æœ‰localhostè¿æ¥</li>
                <li>å·²å¯¼å…¥æ–°çš„Ganacheè´¦æˆ·</li>
                <li>å½“å‰ç½‘ç»œä¸ºGanache Local (Chain ID: 1337)</li>
            </ul>
        </div>
        
        <button class="button" onclick="step1_FreshConnect()">ğŸ”Œ ç¬¬1æ­¥ï¼šå…¨æ–°è¿æ¥MetaMask</button>
        <button class="button" onclick="step2_TestTransaction()">ğŸ’¸ ç¬¬2æ­¥ï¼šæµ‹è¯•äº¤æ˜“</button>
        <button class="button" onclick="step3_TestContract()">ğŸ“„ ç¬¬3æ­¥ï¼šæµ‹è¯•åˆçº¦è°ƒç”¨</button>
        <button class="button" onclick="clearResults()">ğŸ§¹ æ¸…é™¤ç»“æœ</button>
        
        <div id="results"></div>
    </div>

    <script>
        function log(message, type = 'step') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `step ${type}`;
            div.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            results.appendChild(div);
            console.log(message);
            div.scrollIntoView({ behavior: 'smooth' });
        }
        
        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }
        
        async function step1_FreshConnect() {
            log('ğŸ”Œ å¼€å§‹å…¨æ–°è¿æ¥æµç¨‹...', 'step');
            
            if (typeof window.ethereum === 'undefined') {
                log('âŒ MetaMaskæœªæ£€æµ‹åˆ°ï¼Œè¯·å®‰è£…MetaMaskæ‰©å±•', 'error');
                return;
            }
            
            try {
                // é¦–å…ˆæ£€æŸ¥å½“å‰çŠ¶æ€
                log('ğŸ” æ£€æŸ¥å½“å‰è¿æ¥çŠ¶æ€...', 'step');
                const currentAccounts = await window.ethereum.request({ method: 'eth_accounts' });
                
                if (currentAccounts.length > 0) {
                    log(`âš ï¸ æ£€æµ‹åˆ°å·²è¿æ¥è´¦æˆ·: ${currentAccounts[0]}`, 'warning');
                    log('å»ºè®®å…ˆåœ¨MetaMaskä¸­æ–­å¼€è¿æ¥ï¼Œç„¶åé‡æ–°æµ‹è¯•', 'warning');
                }
                
                // è¯·æ±‚æ–°çš„è¿æ¥
                log('ğŸ“± è¯·æ±‚è¿æ¥MetaMask...', 'step');
                log('ğŸ”¥ <strong>ç°åœ¨åº”è¯¥å¼¹å‡ºMetaMaskè¿æ¥è¯·æ±‚ï¼</strong>', 'warning');
                
                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });
                
                log(`âœ… è¿æ¥æˆåŠŸï¼è´¦æˆ·: ${accounts[0]}`, 'success');
                
                // éªŒè¯ç½‘ç»œ
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                const chainIdNum = parseInt(chainId, 16);
                
                if (chainIdNum === 1337) {
                    log(`âœ… ç½‘ç»œæ­£ç¡®ï¼šGanache Local (${chainIdNum})`, 'success');
                } else {
                    log(`âš ï¸ ç½‘ç»œä¸æ­£ç¡®ï¼šå½“å‰ä¸º ${chainIdNum}ï¼Œè¯·åˆ‡æ¢åˆ°Ganache (1337)`, 'warning');
                }
                
                // æ£€æŸ¥ä½™é¢
                const balance = await window.ethereum.request({
                    method: 'eth_getBalance',
                    params: [accounts[0], 'latest']
                });
                const balanceEth = parseInt(balance, 16) / Math.pow(10, 18);
                log(`ğŸ’° è´¦æˆ·ä½™é¢: ${balanceEth.toFixed(4)} ETH`, 'success');
                
            } catch (error) {
                if (error.code === 4001) {
                    log('â„¹ï¸ ç”¨æˆ·å–æ¶ˆäº†è¿æ¥è¯·æ±‚', 'warning');
                } else {
                    log(`âŒ è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                }
            }
        }
        
        async function step2_TestTransaction() {
            log('ğŸ’¸ æµ‹è¯•åŸºç¡€äº¤æ˜“åŠŸèƒ½...', 'step');
            
            try {
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                
                if (accounts.length === 0) {
                    log('âš ï¸ è¯·å…ˆå®Œæˆç¬¬1æ­¥è¿æ¥', 'warning');
                    return;
                }
                
                log('ğŸ“¤ å‘é€æµ‹è¯•äº¤æ˜“...', 'step');
                log('ğŸš¨ <strong>é‡ç‚¹å…³æ³¨ï¼šMetaMaskåº”è¯¥å¼¹å‡ºäº¤æ˜“ç¡®è®¤çª—å£ï¼</strong>', 'warning');
                
                const txParams = {
                    from: accounts[0],
                    to: accounts[0],
                    value: '0x1BC16D674EC80000', // 2 ETH
                    gas: '0x5208'
                };
                
                log(`äº¤æ˜“è¯¦æƒ…: å‘é€ 2 ETH ç»™è‡ªå·±`, 'step');
                
                const txHash = await window.ethereum.request({
                    method: 'eth_sendTransaction',
                    params: [txParams]
                });
                
                log(`ğŸ‰ äº¤æ˜“æˆåŠŸï¼Hash: ${txHash}`, 'success');
                log('âœ… MetaMaskå¼¹çª—åŠŸèƒ½æ­£å¸¸å·¥ä½œï¼', 'success');
                
            } catch (error) {
                if (error.code === 4001) {
                    log('âœ… ç”¨æˆ·å–æ¶ˆäº¤æ˜“ - ä½†è¿™è¯´æ˜å¼¹çª—æ˜¯æ­£å¸¸çš„ï¼', 'success');
                } else {
                    log(`âŒ äº¤æ˜“å¤±è´¥ (${error.code}): ${error.message}`, 'error');
                }
            }
        }
        
        async function step3_TestContract() {
            log('ğŸ“„ æµ‹è¯•æ™ºèƒ½åˆçº¦è°ƒç”¨...', 'step');
            
            try {
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                
                if (accounts.length === 0) {
                    log('âš ï¸ è¯·å…ˆå®Œæˆç¬¬1æ­¥è¿æ¥', 'warning');
                    return;
                }
                
                const contractAddress = "0xf3dcB0d7497694405D433de5F46C6e77A8Fc467E";
                const depositAmount = '0x16345785D8A0000'; // 0.1 ETH
                
                log('ğŸ“„ è°ƒç”¨SimpleBankåˆçº¦å­˜æ¬¾åŠŸèƒ½...', 'step');
                log('ğŸš¨ <strong>åº”è¯¥å¼¹å‡ºMetaMaskåˆçº¦äº¤äº’ç¡®è®¤ï¼</strong>', 'warning');
                
                const txHash = await window.ethereum.request({
                    method: 'eth_sendTransaction',
                    params: [{
                        from: accounts[0],
                        to: contractAddress,
                        value: depositAmount,
                        data: '0xd0e30db0', // deposit() å‡½æ•°é€‰æ‹©å™¨
                        gas: '0x186A0'
                    }]
                });
                
                log(`ğŸ‰ åˆçº¦è°ƒç”¨æˆåŠŸï¼Hash: ${txHash}`, 'success');
                log('âœ… æ™ºèƒ½åˆçº¦äº¤äº’åŠŸèƒ½æ­£å¸¸ï¼', 'success');
                
            } catch (error) {
                if (error.code === 4001) {
                    log('âœ… ç”¨æˆ·å–æ¶ˆåˆçº¦è°ƒç”¨ - å¼¹çª—åŠŸèƒ½æ­£å¸¸ï¼', 'success');
                } else {
                    log(`âŒ åˆçº¦è°ƒç”¨å¤±è´¥ (${error.code}): ${error.message}`, 'error');
                }
            }
        }
        
        // ç›‘å¬MetaMaskäº‹ä»¶
        if (typeof window.ethereum !== 'undefined') {
            window.ethereum.on('accountsChanged', function (accounts) {
                log(`ğŸ”„ è´¦æˆ·å˜æ›´: ${accounts[0] || 'å·²æ–­å¼€'}`, 'warning');
            });
            
            window.ethereum.on('chainChanged', function (chainId) {
                const chainIdNum = parseInt(chainId, 16);
                log(`ğŸ”„ ç½‘ç»œå˜æ›´: ${chainIdNum}`, 'warning');
            });
        }
        
        log('ğŸš€ å…¨æ–°è¿æ¥æµ‹è¯•å·¥å…·å·²åŠ è½½', 'success');
        log('ğŸ“‹ è¯·æŒ‰é¡ºåºæ‰§è¡Œæµ‹è¯•æ­¥éª¤', 'step');
    </script>
</body>
</html> 