<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¢å¼ºç‰ˆç½‘ç»œè¿æ¥è°ƒè¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .warning { background-color: #fff3cd; color: #856404; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .disabled {
            background-color: #6c757d !important;
            cursor: not-allowed !important;
        }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
        }
        .progress {
            background-color: #f0f0f0;
            border-radius: 10px;
            padding: 3px;
            margin: 10px 0;
        }
        .progress-bar {
            background-color: #007bff;
            height: 20px;
            border-radius: 8px;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>ğŸ” å¢å¼ºç‰ˆ Web3 ç½‘ç»œè¿æ¥è°ƒè¯•å·¥å…·</h1>
    
    <div id="status"></div>
    
    <h2>è¯¦ç»†æµ‹è¯•æ­¥éª¤</h2>
    <button onclick="testDetailedTransaction()">ğŸš€ æµ‹è¯•è¯¦ç»†äº¤æ˜“æµç¨‹</button>
    <button onclick="testBankDeposit()">ğŸ’° æµ‹è¯•é“¶è¡Œå­˜æ¬¾</button>
    <button onclick="clearResults()">ğŸ§¹ æ¸…é™¤ç»“æœ</button>
    
    <div id="results"></div>

    <script>
        let accounts = [];
        let chainId;
        
        const contractAddresses = {
            "1337": {
                "SimpleBank": "0xf3dcB0d7497694405D433de5F46C6e77A8Fc467E",
                "VotingCore": "0x0ea3dd08Fe63166DdEeFf22745CB774CfAD03337"
            }
        };
        
        // SimpleBank ABI (ç®€åŒ–ç‰ˆï¼ŒåªåŒ…å«éœ€è¦çš„å‡½æ•°)
        const SimpleBankABI = [
            "function deposit() payable",
            "function getBalance(address account) view returns (uint256)",
            "function minimumDeposit() view returns (uint256)",
            "function withdraw(uint256 amount)",
            "function getAccountInfo(address account) view returns (uint256, uint256, uint256)"
        ];
        
        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            results.appendChild(div);
            console.log(message);
            
            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            results.scrollTop = results.scrollHeight;
        }
        
        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }
        
        // å¸¦è¶…æ—¶çš„PromiseåŒ…è£…å™¨
        function withTimeout(promise, timeoutMs, timeoutMessage) {
            return Promise.race([
                promise,
                new Promise((_, reject) => 
                    setTimeout(() => reject(new Error(timeoutMessage)), timeoutMs)
                )
            ]);
        }
        
        // åˆå§‹åŒ–è¿æ¥
        async function initConnection() {
            if (typeof window.ethereum === 'undefined') {
                throw new Error('æœªæ£€æµ‹åˆ° MetaMask');
            }
            
            // è¯·æ±‚è¿æ¥é’±åŒ…
            accounts = await window.ethereum.request({
                method: 'eth_requestAccounts'
            });
            
            if (accounts.length === 0) {
                throw new Error('æ²¡æœ‰å¯ç”¨çš„è´¦æˆ·');
            }
            
            // è·å–å½“å‰ç½‘ç»œ
            chainId = await window.ethereum.request({
                method: 'eth_chainId'
            });
            
            const chainIdDecimal = parseInt(chainId, 16);
            if (chainIdDecimal !== 1337) {
                throw new Error(`å½“å‰ä¸åœ¨ Ganache ç½‘ç»œï¼Œå½“å‰ç½‘ç»œ: ${chainIdDecimal}`);
            }
            
            return { accounts, chainId: chainIdDecimal };
        }
        
        async function testDetailedTransaction() {
            log('ğŸš€ å¼€å§‹è¯¦ç»†äº¤æ˜“æµ‹è¯•...', 'info');
            
            try {
                // ç¬¬1æ­¥ï¼šåˆå§‹åŒ–è¿æ¥
                log('ç¬¬1æ­¥ï¼šåˆå§‹åŒ–è¿æ¥...', 'info');
                const { accounts: connectedAccounts, chainId: currentChainId } = await withTimeout(
                    initConnection(),
                    10000,
                    'è¿æ¥è¶…æ—¶ (10ç§’)'
                );
                log(`âœ… è¿æ¥æˆåŠŸ - è´¦æˆ·: ${connectedAccounts[0]}, ç½‘ç»œ: ${currentChainId}`, 'success');
                
                // ç¬¬2æ­¥ï¼šæ£€æŸ¥ä½™é¢
                log('ç¬¬2æ­¥ï¼šæ£€æŸ¥è´¦æˆ·ä½™é¢...', 'info');
                const balance = await withTimeout(
                    window.ethereum.request({
                        method: 'eth_getBalance',
                        params: [accounts[0], 'latest']
                    }),
                    5000,
                    'è·å–ä½™é¢è¶…æ—¶'
                );
                const balanceInEth = parseInt(balance, 16) / Math.pow(10, 18);
                log(`âœ… å½“å‰ä½™é¢: ${balanceInEth.toFixed(4)} ETH`, 'success');
                
                // ç¬¬3æ­¥ï¼šå‡†å¤‡äº¤æ˜“å‚æ•°
                log('ç¬¬3æ­¥ï¼šå‡†å¤‡äº¤æ˜“å‚æ•°...', 'info');
                const txParams = {
                    from: accounts[0],
                    to: accounts[0], // è½¬ç»™è‡ªå·±
                    value: '0x0', // 0 ETH
                    gas: '0x5208', // 21000 gas
                    gasPrice: '0x4A817C800' // 20 Gwei
                };
                log(`âœ… äº¤æ˜“å‚æ•°å‡†å¤‡å®Œæˆ`, 'success');
                log(`<pre>${JSON.stringify(txParams, null, 2)}</pre>`, 'info');
                
                // ç¬¬4æ­¥ï¼šå‘é€äº¤æ˜“ï¼ˆå¸¦è¯¦ç»†ç›‘æ§ï¼‰
                log('ç¬¬4æ­¥ï¼šå‘é€äº¤æ˜“...', 'info');
                log('âš ï¸ è¯·æ³¨æ„æ£€æŸ¥ MetaMask å¼¹çª—ï¼', 'warning');
                
                let txHash;
                try {
                    // è®¾ç½®è¾ƒé•¿çš„è¶…æ—¶æ—¶é—´ï¼Œç»™ç”¨æˆ·æ—¶é—´ç¡®è®¤
                    txHash = await withTimeout(
                        window.ethereum.request({
                            method: 'eth_sendTransaction',
                            params: [txParams]
                        }),
                        60000, // 60ç§’è¶…æ—¶
                        'äº¤æ˜“å‘é€è¶…æ—¶ - å¯èƒ½æ˜¯ç”¨æˆ·å–æ¶ˆæˆ–MetaMaskæ— å“åº”'
                    );
                    log(`âœ… äº¤æ˜“å‘é€æˆåŠŸ! Hash: ${txHash}`, 'success');
                } catch (error) {
                    if (error.message.includes('User denied')) {
                        log('â„¹ï¸ ç”¨æˆ·å–æ¶ˆäº†äº¤æ˜“', 'warning');
                        return;
                    } else if (error.message.includes('timeout') || error.message.includes('è¶…æ—¶')) {
                        log('âš ï¸ äº¤æ˜“å‘é€è¶…æ—¶ - è¯·æ£€æŸ¥ MetaMask æ˜¯å¦æœ‰å¾…ç¡®è®¤çš„äº¤æ˜“', 'warning');
                        log('ğŸ”§ è§£å†³æ–¹æ¡ˆ: ç‚¹å‡» MetaMask æ‰©å±•å›¾æ ‡ï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰æœªç¡®è®¤çš„äº¤æ˜“', 'info');
                        return;
                    } else {
                        throw error;
                    }
                }
                
                // ç¬¬5æ­¥ï¼šç­‰å¾…äº¤æ˜“ç¡®è®¤
                log('ç¬¬5æ­¥ï¼šç­‰å¾…äº¤æ˜“ç¡®è®¤...', 'info');
                let receipt = null;
                let attempts = 0;
                const maxAttempts = 30;
                
                // åˆ›å»ºè¿›åº¦æ¡
                const progressDiv = document.createElement('div');
                progressDiv.className = 'progress';
                progressDiv.innerHTML = '<div class="progress-bar" style="width: 0%">ç­‰å¾…ç¡®è®¤...</div>';
                document.getElementById('results').appendChild(progressDiv);
                
                while (!receipt && attempts < maxAttempts) {
                    try {
                        receipt = await window.ethereum.request({
                            method: 'eth_getTransactionReceipt',
                            params: [txHash]
                        });
                        
                        if (!receipt) {
                            attempts++;
                            const progress = (attempts / maxAttempts) * 100;
                            progressDiv.querySelector('.progress-bar').style.width = `${progress}%`;
                            progressDiv.querySelector('.progress-bar').textContent = `ç­‰å¾…ç¡®è®¤... ${attempts}/${maxAttempts}`;
                            await new Promise(resolve => setTimeout(resolve, 1000));
                        }
                    } catch (error) {
                        log(`âš ï¸ è·å–äº¤æ˜“æ”¶æ®å¤±è´¥ (å°è¯• ${attempts + 1}): ${error.message}`, 'warning');
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        attempts++;
                    }
                }
                
                // ç§»é™¤è¿›åº¦æ¡
                progressDiv.remove();
                
                if (receipt) {
                    log(`âœ… äº¤æ˜“ç¡®è®¤æˆåŠŸ!`, 'success');
                    log(`   åŒºå—å·: ${parseInt(receipt.blockNumber, 16)}`, 'success');
                    log(`   Gas ä½¿ç”¨: ${parseInt(receipt.gasUsed, 16)}`, 'success');
                    log(`   çŠ¶æ€: ${receipt.status === '0x1' ? 'æˆåŠŸ' : 'å¤±è´¥'}`, receipt.status === '0x1' ? 'success' : 'error');
                    log('ğŸ‰ äº¤æ˜“æµç¨‹å®Œå…¨æ­£å¸¸ï¼', 'success');
                } else {
                    log('âš ï¸ äº¤æ˜“å‘é€æˆåŠŸä½†ç¡®è®¤è¶…æ—¶', 'warning');
                    log('è¿™å¯èƒ½æ˜¯æ­£å¸¸çš„ï¼Œäº¤æ˜“å¯èƒ½ä»åœ¨å¤„ç†ä¸­', 'info');
                }
                
            } catch (error) {
                log(`âŒ è¯¦ç»†äº¤æ˜“æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                
                // æä¾›è¯¦ç»†çš„é”™è¯¯åˆ†æ
                if (error.message.includes('User denied')) {
                    log('ğŸ”§ è§£å†³æ–¹æ¡ˆ: ç”¨æˆ·å–æ¶ˆäº†äº¤æ˜“ï¼Œè¿™æ˜¯æ­£å¸¸çš„', 'info');
                } else if (error.message.includes('insufficient funds')) {
                    log('ğŸ”§ è§£å†³æ–¹æ¡ˆ: è´¦æˆ·ä½™é¢ä¸è¶³', 'info');
                } else if (error.message.includes('timeout') || error.message.includes('è¶…æ—¶')) {
                    log('ğŸ”§ å¯èƒ½çš„åŸå› :', 'info');
                    log('1. MetaMask å¼¹çª—è¢«é˜»æ­¢', 'info');
                    log('2. MetaMask æ‰©å±•æ— å“åº”', 'info');
                    log('3. ç½‘ç»œè¿æ¥é—®é¢˜', 'info');
                } else {
                    log('ğŸ”§ é€šç”¨è§£å†³æ–¹æ¡ˆ:', 'info');
                    log('1. åˆ·æ–°é¡µé¢é‡è¯•', 'info');
                    log('2. é‡å¯ MetaMask', 'info');
                    log('3. æ£€æŸ¥ Ganache çŠ¶æ€', 'info');
                }
            }
        }
        
        async function testBankDeposit() {
            log('ğŸ’° æµ‹è¯•é“¶è¡Œå­˜æ¬¾äº¤æ˜“...', 'info');
            
            try {
                await initConnection();
                
                const bankAddress = contractAddresses["1337"].SimpleBank;
                const depositAmount = '0x16345785D8A0000'; // 0.1 ETH in wei
                
                // æ„é€ å­˜æ¬¾äº¤æ˜“
                const txParams = {
                    from: accounts[0],
                    to: bankAddress,
                    value: depositAmount,
                    data: '0xd0e30db0', // deposit() å‡½æ•°é€‰æ‹©å™¨
                    gas: '0x186A0', // 100000 gas
                    gasPrice: '0x4A817C800' // 20 Gwei
                };
                
                log('å‡†å¤‡å‘é€å­˜æ¬¾äº¤æ˜“...', 'info');
                log(`å­˜æ¬¾é‡‘é¢: 0.1 ETH`, 'info');
                log('âš ï¸ è¯·ç¡®è®¤ MetaMask å¼¹çª—ï¼', 'warning');
                
                const txHash = await withTimeout(
                    window.ethereum.request({
                        method: 'eth_sendTransaction',
                        params: [txParams]
                    }),
                    60000,
                    'å­˜æ¬¾äº¤æ˜“è¶…æ—¶'
                );
                
                log(`âœ… å­˜æ¬¾äº¤æ˜“å‘é€æˆåŠŸ! Hash: ${txHash}`, 'success');
                log('ğŸ”„ ç­‰å¾…äº¤æ˜“ç¡®è®¤...', 'info');
                
                // ç­‰å¾…ç¡®è®¤
                let receipt = null;
                let attempts = 0;
                
                while (!receipt && attempts < 30) {
                    receipt = await window.ethereum.request({
                        method: 'eth_getTransactionReceipt',
                        params: [txHash]
                    });
                    
                    if (!receipt) {
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        attempts++;
                    }
                }
                
                if (receipt) {
                    log(`âœ… å­˜æ¬¾äº¤æ˜“ç¡®è®¤æˆåŠŸ! åŒºå—: ${parseInt(receipt.blockNumber, 16)}`, 'success');
                    log('ğŸ‰ é“¶è¡Œå­˜æ¬¾åŠŸèƒ½æ­£å¸¸ï¼', 'success');
                } else {
                    log('âš ï¸ å­˜æ¬¾äº¤æ˜“ç¡®è®¤è¶…æ—¶', 'warning');
                }
                
            } catch (error) {
                log(`âŒ é“¶è¡Œå­˜æ¬¾æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                
                if (error.message.includes('User denied')) {
                    log('â„¹ï¸ ç”¨æˆ·å–æ¶ˆäº†å­˜æ¬¾äº¤æ˜“', 'info');
                } else if (error.message.includes('timeout')) {
                    log('âš ï¸ å­˜æ¬¾äº¤æ˜“è¶…æ—¶ - æ£€æŸ¥ MetaMask å¼¹çª—', 'warning');
                }
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºåˆå§‹çŠ¶æ€
        window.addEventListener('load', function() {
            log('ğŸš€ å¢å¼ºç‰ˆç½‘ç»œè¿æ¥è°ƒè¯•å·¥å…·å·²åŠ è½½', 'info');
            log('è¿™ä¸ªå·¥å…·æä¾›æ›´è¯¦ç»†çš„äº¤æ˜“æµ‹è¯•å’Œé”™è¯¯åˆ†æ', 'info');
            log('ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•...', 'info');
        });
        
        // ç›‘å¬ MetaMask äº‹ä»¶
        if (typeof window.ethereum !== 'undefined') {
            window.ethereum.on('accountsChanged', function (accounts) {
                log(`ğŸ”„ è´¦æˆ·å·²æ›´æ”¹: ${accounts[0] || 'æ— è´¦æˆ·'}`, 'info');
            });
            
            window.ethereum.on('chainChanged', function (chainId) {
                const chainIdDecimal = parseInt(chainId, 16);
                log(`ğŸ”„ ç½‘ç»œå·²æ›´æ”¹: ${chainIdDecimal}`, 'info');
            });
        }
    </script>
</body>
</html> 