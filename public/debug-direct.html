<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç›´æ¥æµ‹è¯•MetaMaskå¼¹çª—</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .button {
            background-color: #ff6b35;
            color: white;
            border: none;
            padding: 20px 40px;
            border-radius: 10px;
            cursor: pointer;
            margin: 15px;
            font-size: 18px;
            font-weight: bold;
        }
        .button:hover {
            background-color: #e55a2b;
        }
        .result {
            margin: 15px 0;
            padding: 15px;
            border-radius: 8px;
            background-color: #f8f9fa;
            border-left: 4px solid #007bff;
        }
        .warning {
            background-color: #fff3cd;
            border-left-color: #ffc107;
            color: #856404;
        }
        .success {
            background-color: #d4edda;
            border-left-color: #28a745;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border-left-color: #dc3545;
            color: #721c24;
        }
    </style>
</head>
<body>
    <h1>ğŸ”¥ å¼ºåˆ¶æµ‹è¯• MetaMask å¼¹çª—</h1>
    
    <div class="warning">
        <strong>âš ï¸ é‡è¦æç¤ºï¼š</strong><br>
        1. ç¡®ä¿MetaMaskæ‰©å±•å·²è§£é”<br>
        2. æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦é˜»æ­¢äº†å¼¹çª—<br>
        3. æ¯æ¬¡ç‚¹å‡»åè¯·ä»”ç»†è§‚å¯Ÿå±å¹•å˜åŒ–
    </div>
    
    <button class="button" onclick="forceMetaMaskPopup()">ğŸš€ å¼ºåˆ¶è§¦å‘ MetaMask å¼¹çª—</button>
    <button class="button" onclick="checkMetaMaskState()">ğŸ” æ£€æŸ¥ MetaMask çŠ¶æ€</button>
    <button class="button" onclick="testMinimalTransaction()">ğŸ’¸ æœ€ç®€å•äº¤æ˜“æµ‹è¯•</button>
    
    <div id="results"></div>

    <script>
        function log(message, type = 'result') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            results.appendChild(div);
            console.log(message);
            
            // è‡ªåŠ¨æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯
            div.scrollIntoView({ behavior: 'smooth' });
        }
        
        async function checkMetaMaskState() {
            log('ğŸ” æ£€æŸ¥ MetaMask è¯¦ç»†çŠ¶æ€...', 'result');
            
            if (typeof window.ethereum === 'undefined') {
                log('âŒ MetaMask æœªæ£€æµ‹åˆ°', 'error');
                return;
            }
            
            try {
                // æ£€æŸ¥è¿æ¥çŠ¶æ€
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                log(`ğŸ“± å½“å‰è´¦æˆ·: ${accounts[0] || 'æœªè¿æ¥'}`, accounts[0] ? 'success' : 'warning');
                
                // æ£€æŸ¥ç½‘ç»œ
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                log(`ğŸŒ å½“å‰ç½‘ç»œ: ${parseInt(chainId, 16)} (${chainId})`, 'success');
                
                // æ£€æŸ¥æ˜¯å¦è§£é”
                const isUnlocked = await window.ethereum._metamask.isUnlocked();
                log(`ğŸ”“ MetaMask è§£é”çŠ¶æ€: ${isUnlocked ? 'å·²è§£é”' : 'å·²é”å®š'}`, isUnlocked ? 'success' : 'error');
                
                // æ£€æŸ¥æƒé™
                const permissions = await window.ethereum.request({
                    method: 'wallet_getPermissions'
                });
                log(`ğŸ”‘ æƒé™æ•°é‡: ${permissions.length}`, 'success');
                
            } catch (error) {
                log(`âŒ çŠ¶æ€æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        async function forceMetaMaskPopup() {
            log('ğŸš€ å¼€å§‹å¼ºåˆ¶è§¦å‘ MetaMask å¼¹çª—...', 'warning');
            
            try {
                // é¦–å…ˆç¡®ä¿è¿æ¥
                log('ç¬¬1æ­¥: è¯·æ±‚è´¦æˆ·è¿æ¥...', 'result');
                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });
                log(`âœ… è´¦æˆ·è¿æ¥æˆåŠŸ: ${accounts[0]}`, 'success');
                
                // æ·»åŠ å»¶è¿Ÿç¡®ä¿MetaMaskå‡†å¤‡å°±ç»ª
                log('ç¬¬2æ­¥: ç­‰å¾…2ç§’ç¡®ä¿MetaMaskå‡†å¤‡å°±ç»ª...', 'result');
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // å‘é€æœ€ç®€å•çš„äº¤æ˜“
                log('ç¬¬3æ­¥: å‘é€äº¤æ˜“è¯·æ±‚...', 'warning');
                log('ğŸ”¥ <strong>ç°åœ¨åº”è¯¥å¼¹å‡º MetaMask ç¡®è®¤çª—å£ï¼</strong>', 'warning');
                log('ğŸ‘€ è¯·ä»”ç»†æ£€æŸ¥ï¼š', 'warning');
                log('- å±å¹•ä¸­å¤®æ˜¯å¦æœ‰å¼¹çª—', 'warning');
                log('- ä»»åŠ¡æ æ˜¯å¦æœ‰é—ªçƒçš„MetaMaskå›¾æ ‡', 'warning');
                log('- æµè§ˆå™¨åœ°å€æ æ˜¯å¦æœ‰å¼¹çª—é˜»æ­¢å›¾æ ‡', 'warning');
                
                const txHash = await window.ethereum.request({
                    method: 'eth_sendTransaction',
                    params: [{
                        from: accounts[0],
                        to: accounts[0],
                        value: '0x1', // 1 wei (æå°é‡‘é¢)
                        gas: '0x5208'
                    }]
                });
                
                log(`ğŸ‰ äº¤æ˜“æˆåŠŸå‘é€ï¼Hash: ${txHash}`, 'success');
                log('âœ… MetaMask å¼¹çª—åŠŸèƒ½æ­£å¸¸ï¼', 'success');
                
            } catch (error) {
                if (error.code === 4001) {
                    log('â„¹ï¸ ç”¨æˆ·åœ¨MetaMaskä¸­å–æ¶ˆäº†äº¤æ˜“', 'warning');
                    log('âœ… è¿™è¯´æ˜MetaMaskå¼¹çª—æ˜¯æ­£å¸¸çš„ï¼', 'success');
                } else if (error.code === -32603) {
                    log('âš ï¸ å†…éƒ¨JSON-RPCé”™è¯¯ï¼Œä½†è¿™è¡¨æ˜è¯·æ±‚åˆ°è¾¾äº†MetaMask', 'warning');
                } else {
                    log(`âŒ é”™è¯¯ (ä»£ç : ${error.code}): ${error.message}`, 'error');
                }
            }
        }
        
        async function testMinimalTransaction() {
            log('ğŸ’¸ æµ‹è¯•æœ€ç®€å•çš„äº¤æ˜“...', 'result');
            
            try {
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                
                if (accounts.length === 0) {
                    log('âš ï¸ è¯·å…ˆè¿æ¥MetaMaskè´¦æˆ·', 'warning');
                    return;
                }
                
                log('ğŸ“¤ å‘é€0 ETHè½¬è´¦ç»™è‡ªå·±...', 'result');
                log('ğŸ”” <strong>è¯·æ³¨æ„MetaMaskå¼¹çª—ï¼</strong>', 'warning');
                
                // æœ€ç®€å•çš„0 ETHè½¬è´¦
                const result = await window.ethereum.request({
                    method: 'eth_sendTransaction',
                    params: [{
                        from: accounts[0],
                        to: accounts[0],
                        value: '0x0'
                    }]
                });
                
                log(`âœ… æœ€ç®€å•äº¤æ˜“æˆåŠŸ: ${result}`, 'success');
                
            } catch (error) {
                if (error.code === 4001) {
                    log('âœ… ç”¨æˆ·å–æ¶ˆ - è¯´æ˜å¼¹çª—æ­£å¸¸å·¥ä½œï¼', 'success');
                } else {
                    log(`âŒ äº¤æ˜“å¤±è´¥: ${error.message}`, 'error');
                }
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåçš„æç¤º
        window.addEventListener('load', function() {
            log('ğŸš€ å¼ºåˆ¶MetaMaskå¼¹çª—æµ‹è¯•å·¥å…·å·²åŠ è½½', 'success');
            log('ğŸ“‹ æµ‹è¯•æ­¥éª¤:', 'result');
            log('1. ç‚¹å‡»"æ£€æŸ¥ MetaMask çŠ¶æ€"ç¡®è®¤åŸºæœ¬çŠ¶æ€', 'result');
            log('2. ç‚¹å‡»"å¼ºåˆ¶è§¦å‘ MetaMask å¼¹çª—"è¿›è¡Œä¸»è¦æµ‹è¯•', 'result');
            log('3. å¦‚æœä»æ— å¼¹çª—ï¼Œç‚¹å‡»"æœ€ç®€å•äº¤æ˜“æµ‹è¯•"', 'result');
        });
    </script>
</body>
</html> 